version: '3'
services:
  traefik:
    image: traefik:latest
    restart: unless-stopped
    ports:
      - 80:80/tcp
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --providers.docker.network=dns_traefik
      - --log.level=DEBUG
      - --api.dashboard=true
    labels:
      - traefik.enable=true
      - traefik.http.routers.api.rule=Host(`traefik.internal.prstat.org`)
      - traefik.http.routers.api.service=api@internal
      - traefik.http.routers.api-default.rule=PathPrefix(`/`)
      - traefik.http.routers.api-default.service=api@internal
      - traefik.http.routers.api-default.priority=1
    networks: 
      - default
      - traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
  dns-server:
    image: technitium/dns-server:latest
    ports:
      - 53:53/udp
      - 53:53/tcp
      - 5380:5380
      - 53443:53443 # https web console
      #- 67:67/udp # dhcp
    labels:
      - traefik.enable=true
      - traefik.http.routers.dns.rule=Host(`dns.internal.prstat.org`)
      - traefik.http.routers.dns.service=dns
      - traefik.http.services.dns.loadbalancer.server.port=5380
    environment:
      DNS_SERVER_DOMAIN: internal.prstat.org
    volumes:
      - config:/etc/dns
    restart: unless-stopped
    networks:
      - traefik
    sysctls:
      - net.ipv4.ip_local_port_range=1024 65000
volumes:
  config:
networks:
  traefik:
